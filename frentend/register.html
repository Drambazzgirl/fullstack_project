<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Voice of TN</title>
    <link rel="stylesheet" href="../frentend/css/register.css">
</head>

<body>
    <nav class="navbar">
        <div class="logo">ðŸ”Š Voice of TN</div>
        <div class="nav-links">
            <a href="../index.html">Home</a>
            <a href="../frentend/login.html">Login</a>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <h2>Create Account</h2>
            <div class="success-message" id="successMessage"></div>
            <form id="registerForm">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="name" required>
                    <div class="error-message" id="nameError"></div>
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="email" required>
                    <div class="error-message" id="emailError"></div>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="phone" pattern="[0-9]{10}" placeholder="10 digit number" required>
                    <div class="error-message" id="phoneError"></div>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" minlength="6" required>
                    <div class="error-message" id="passwordError"></div>
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="confirmPassword" required>
                    <div class="error-message" id="confirmPasswordError"></div>
                </div>
                <div class="form-group">
                    <label>Profile Picture (Optional)</label>
                    <input type="file" id="profilePicture" accept="image/*">
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn">Register</button>
            </form>
            <p class="text-center">
                Already have an account? <a href="../frentend/login.html">Login here</a>
            </p>
        </div>
    </div>

    <footer>
        @2026 Voice of TN, ALL Rights Reserved
    </footer>

    <script>
        const form = document.getElementById('registerForm');
        const submitBtn = document.getElementById('submitBtn');
        const successMessage = document.getElementById('successMessage');
        const API_BASE_URL = 'http://localhost:8000/api';

        // Clear error message
        function clearError(field) {
            const errorDiv = document.getElementById(field + 'Error');
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
        }

        // Show error message
        function showError(field, message) {
            const errorDiv = document.getElementById(field + 'Error');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        // Validate email format
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Validate phone number
        function isValidPhone(phone) {
            const phoneRegex = /^[0-9]{10}$/;
            return phoneRegex.test(phone);
        }

        // Clear all errors when user types
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', function () {
                clearError(this.id);
            });
        });

        // Handle form submission
        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            // Clear all previous errors
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            successMessage.style.display = 'none';

            // Get form values
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const profilePicFile = document.getElementById('profilePicture').files[0];

            let hasError = false;

            // ... (validations remain same)
            if (name.length < 2) { showError('name', 'Name must be at least 2 characters'); hasError = true; }
            if (!isValidEmail(email)) { showError('email', 'Please enter a valid email address'); hasError = true; }
            if (!isValidPhone(phone)) { showError('phone', 'Please enter a valid 10-digit phone number'); hasError = true; }
            if (password.length < 6) { showError('password', 'Password must be at least 6 characters'); hasError = true; }
            if (password !== confirmPassword) { showError('confirmPassword', 'Passwords do not match'); hasError = true; }

            if (hasError) return;

            submitBtn.disabled = true;
            submitBtn.textContent = 'Registering...';

            try {
                // 1. Register User
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, phone, password })
                });

                if (response.ok) {
                    const userData = await response.json();

                    // 2. If profile pic exists, login first to get token, then upload
                    if (profilePicFile) {
                        try {
                            const loginRes = await fetch(`${API_BASE_URL}/auth/login/json`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ email: email, password: password })
                            });

                            if (loginRes.ok) {
                                const loginData = await loginRes.json();
                                const formData = new FormData();
                                formData.append('file', profilePicFile);

                                await fetch(`${API_BASE_URL}/auth/upload-profile-picture`, {
                                    method: 'POST',
                                    headers: { 'Authorization': `Bearer ${loginData.access_token}` },
                                    body: formData
                                });
                            }
                        } catch (err) {
                            console.error('Initial login/upload failed', err);
                        }
                    }

                    successMessage.textContent = 'Registration successful! Redirecting to login...';
                    successMessage.style.display = 'block';
                    form.reset();
                    setTimeout(() => window.location.href = './login.html', 2000);
                } else {
                    const data = await response.json();
                    showError('email', data.detail || 'Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showError('email', 'Registration failed. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Register';
            }
        });
    </script>
</body>

</html>